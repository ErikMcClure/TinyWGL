function TinyPass(){this.cameraMatrix=Matrix.I(4),this.renderables=[],this.rendertarget=null,this.onDraw=function(){},this.customDraw=function(){}}function TinyWGL(a,b,c,d){var e=a.getContext("webgl")||a.getContext("experimental-webgl");if(this.gl=e,!e)return null;c||(c=60),d||(d=function(a){a.width=window.innerWidth,a.height=window.innerHeight}),this.createShader=createShader,this.getShader=getShader,this.draw=draw,this.createVertexBuffer=createVertexBuffer,this.createIndexBuffer=createIndexBuffer,this.applyShader=applyShader,this.setTexture=setTexture,this.loadTexture=loadTexture,this.defaultTexLoad=defaultTexLoad,this.pow2TexLoad=pow2TexLoad,this.createRenderTarget=createRenderTarget,this.drawRenderable=drawRenderable,this.lastshader=null,this.lastarraybuffer=null,this.lastindexbuffer=null,this.needredraw=!1,this.Mat4x4=function(a,b){e.uniformMatrix4fv(a,!1,new Float32Array(b.flatten()))},this.Float1=function(a,b){e.uniform1f(a,b)},this.Float2=function(a,b){e.uniform2fv(a,new Float32Array(b))},this.Float3=function(a,b){e.uniform3fv(a,new Float32Array(b))},this.Float4=function(a,b){e.uniform4fv(a,new Float32Array(b))};var f=this;this.time=0,this.delta=0,this.lastTime=(new Date).getTime(),this.timeWarp=1,this.basicShader=this.createShader("default-shader-fs","default-shader-vs",{PMat:this.Mat4x4,ModelMat:this.Mat4x4},[["Position",3,0,0]]),this.imgShader=this.createShader("texture-shader-fs","texture-shader-vs",{PMat:this.Mat4x4,ModelMat:this.Mat4x4,Color:function(a,b){f.Float4(a,b?b:[1,1,1,1])},s0:function(a,b){f.setTexture(a,b)}},[["Position",3,20,0],["TexCoord",2,20,12]]),this.identity=Matrix.I(4),this.perspectiveMatrix=this.identity,this.perspectiveCameraMatrix=this.identity,this.pass=[new TinyPass],this.imgIndices=this.createIndexBuffer([0,1,3,0,2,3]);for(var g=[],h=0;h<4;++h)g[5*h]=1&h,g[5*h+1]=-((2&h)>>1),g[5*h+2]=-1,g[5*h+3]=1&h,g[5*h+4]=(2&h)>>1;this.imgVerts=this.createVertexBuffer(g,5),e.clearColor(0,0,0,1),e.enable(e.DEPTH_TEST),e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),e.depthFunc(e.LEQUAL);var i=function(g){d(a),f.canvaswidth=a.width,f.canvasheight=a.height,e.viewport(0,0,a.width,a.height),f.perspectiveMatrix=makePerspective(c,a.width/a.height,.1,b),f.needredraw=!0,f.hfov=2*Math.atan(Math.tan(c*Math.PI/360)*a.width/a.height)};addEvent(window,"resize",i),window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(a){window.setTimeout(a,1e3/60)}}(),i({})}function drawRenderable(a,b,c,d,e){var f=this.gl;for(var g in b.props)b.props[g](b.propLoc[g],e[g]);d?(this.lastindexbuffer!=d&&f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,this.lastindexbuffer=d),f.drawElements(a,d.count,f.UNSIGNED_SHORT,0)):f.drawArrays(a,0,c.count)}function createShader(a,b,c,d){var e=this.gl,f=this.getShader(a),g=this.getShader(b),h=e.createProgram();e.attachShader(h,g),e.attachShader(h,f),e.linkProgram(h),e.getProgramParameter(h,e.LINK_STATUS)||alert("Unable to initialize the shader program."),h.props=c,h.attributes=d;for(var i=0;i<h.attributes.length;i++)h.attributes[i][0]=e.getAttribLocation(h,h.attributes[i][0]);h.propLoc={};for(var j in h.props)h.propLoc[j]=e.getUniformLocation(h,j);return h}function getShader(a){var b=this.gl,c=document.getElementById(a);if(!c)return null;for(var d="",e=c.firstChild;e;)3==e.nodeType&&(d+=e.textContent),e=e.nextSibling;var f;if("x-shader/x-fragment"==c.type)f=b.createShader(b.FRAGMENT_SHADER);else{if("x-shader/x-vertex"!=c.type)return null;f=b.createShader(b.VERTEX_SHADER)}return b.shaderSource(f,d),b.compileShader(f),b.getShaderParameter(f,b.COMPILE_STATUS)?f:(alert(b.getShaderInfoLog(f)),null)}function defaultTexLoad(a,b){var c=this.gl;c.bindTexture(c.TEXTURE_2D,b),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.LINEAR),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.LINEAR),c.texImage2D(c.TEXTURE_2D,0,c.RGBA,c.RGBA,c.UNSIGNED_BYTE,a),c.bindTexture(c.TEXTURE_2D,null)}function pow2TexLoad(a,b){var c=this.gl;c.bindTexture(c.TEXTURE_2D,b),c.texImage2D(c.TEXTURE_2D,0,c.RGBA,c.RGBA,c.UNSIGNED_BYTE,a),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.LINEAR),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.LINEAR_MIPMAP_NEAREST),c.generateMipmap(c.TEXTURE_2D),c.bindTexture(c.TEXTURE_2D,null)}function loadTexture(a,b){var c=this.gl.createTexture(),d=new Image,e=this;return d.onload=b?function(){b(d,c)}:function(){e.defaultTexLoad(d,c)},d.src=a,c}function setTexture(a,b,c){var d=this.gl;c||(c=0),d.activeTexture(d["TEXTURE"+c]),d.bindTexture(d.TEXTURE_2D,b),d.uniform1i(a,c)}function createRenderTarget(a,b){var c=this.gl,d=c.createFramebuffer();c.bindFramebuffer(c.FRAMEBUFFER,d),d.width=a?a:this.canvaswidth,d.height=b?b:this.canvasheight;var e=c.createTexture();c.bindTexture(c.TEXTURE_2D,e),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.LINEAR),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.LINEAR),c.texImage2D(c.TEXTURE_2D,0,c.RGBA,d.width,d.height,0,c.RGBA,c.UNSIGNED_BYTE,null);var f=c.createRenderbuffer();return c.bindRenderbuffer(c.RENDERBUFFER,f),c.renderbufferStorage(c.RENDERBUFFER,c.DEPTH_COMPONENT16,d.width,d.height),c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_2D,e,0),c.framebufferRenderbuffer(c.FRAMEBUFFER,c.DEPTH_ATTACHMENT,c.RENDERBUFFER,f),c.bindTexture(c.TEXTURE_2D,null),c.bindRenderbuffer(c.RENDERBUFFER,null),c.bindFramebuffer(c.FRAMEBUFFER,null),{rt:d,tex:e,renderbuffer:f}}function createVertexBuffer(a,b){b&&0==~~(a.length%b)||alert("vertices.length % elem is not zero! Elem should be the size of each vertex (the number of coordinates in it).");var c=this.gl,d=c.createBuffer();return d.elem=~~b,d.count=~~(a.length/b),c.bindBuffer(c.ARRAY_BUFFER,this.lastarraybuffer=d),c.bufferData(c.ARRAY_BUFFER,new Float32Array(a),c.STATIC_DRAW),d}function createIndexBuffer(a){var b=this.gl,c=b.createBuffer();return c.count=a.length,b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,this.lastindexbuffer=c),b.bufferData(b.ELEMENT_ARRAY_BUFFER,new Uint16Array(a),b.STATIC_DRAW),c}function applyShader(a,b){var c=this.gl;if(a!=this.lastshader){if(null!=this.lastshader&&this.lastshader.attributes.length!=a.attributes.length)for(var d=0;d<this.lastshader.attributes.length;d++)c.disableVertexAttribArray(this.lastshader.attributes[d][0]);if(null==this.lastshader||this.lastshader.attributes.length!=a.attributes.length)for(var d=0;d<a.attributes.length;d++)c.enableVertexAttribArray(a.attributes[d][0]);c.useProgram(this.lastshader=a)}b!=this.lastarraybuffer&&c.bindBuffer(c.ARRAY_BUFFER,this.lastarraybuffer=b);for(var d=0;d<a.attributes.length;d++){var e=a.attributes[d];c.vertexAttribPointer(e[0],e[1],c.FLOAT,!1,e[2],e[3])}}function draw(){var a=this.gl,b=this;window.requestAnimFrame(function(){b.draw()});var c=(new Date).getTime();if(this.delta=c-this.lastTime,this.delta*=this.timeWarp,this.time+=this.delta,this.lastTime=c,0!==this.timeWarp||this.needredraw){a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT),this.needredraw=!1;for(var d=0;d<this.pass.length;d++){var e=this.pass[d];e.onDraw(),this.perspectiveCameraMatrix=this.perspectiveMatrix.x(e.cameraMatrix),a.bindFramebuffer(a.FRAMEBUFFER,e.rendertarget),e.customDraw();for(var f=0;f<e.renderables.length;f++){var g=e.renderables[f];g.render(this)||(b.applyShader(g.shader,g.verts),b.drawRenderable(g.type,g.shader,g.verts,g.indices,g.params))}}}}function TinyRenderable(a,b,c,d,e,f){this.type=a,this.shader=b,this.verts=c,this.indices=d,this.params=e,null==f&&(f=function(){}),this.render=f}function TinyImage(a,b,c,d){"string"==typeof a&&(a=[a]),c||(c=b.imgShader);for(var e={ModelMat:Matrix.I(4)},f=0;f<a.length;++f)e["s"+f]=b.loadTexture(a[f],d?function(a,c){b.pow2TexLoad(a,c)}:0);TinyRenderable.call(this,b.gl.TRIANGLES,c,b.imgVerts,b.imgIndices,e,function(a){this.params.PMat=b.perspectiveCameraMatrix})}function FullScreenQuad(a,b){for(var c=[],d=0;d<4;++d)c[5*d]=((1&d)<<1)-1,c[5*d+1]=-((2&d)-1),c[5*d+2]=0,c[5*d+3]=1&d,c[5*d+4]=(2&d)>>1;TinyRenderable.call(this,b.gl.TRIANGLES,b.imgShader,b.createVertexBuffer(c,5),b.imgIndices,{PMat:Matrix.I(4),ModelMat:Matrix.I(4),s0:a})}var addEvent=function(a,b,c){null!=a&&void 0!=a&&(a.addEventListener?a.addEventListener(b,c,!1):a.attachEvent?a.attachEvent("on"+b,c):a["on"+b]=c)};
