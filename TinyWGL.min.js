function TinyPass(){this.cameraMatrix=Matrix.I(4);this.renderables=[];this.rendertarget=null;this.onDraw=function(){};this.customDraw=function(){}}function TinyWGL(e,t,n){var r=e.getContext("webgl")||e.getContext("experimental-webgl");this.gl=r;if(!r)return null;if(!n)n=60;this.createShader=createShader;this.getShader=getShader;this.draw=draw;this.createVertexBuffer=createVertexBuffer;this.createIndexBuffer=createIndexBuffer;this.applyShader=applyShader;this.setTexture=setTexture;this.loadTexture=loadTexture;this.defaultTexLoad=defaultTexLoad;this.pow2TexLoad=pow2TexLoad;this.createRenderTarget=createRenderTarget;this.render=tinywgl_render;this.needredraw=false;this.Mat4x4=function(e,t){r.uniformMatrix4fv(e,false,new Float32Array(t.flatten()))};this.Float1=function(e,t){r.uniform1f(e,t)};this.Float2=function(e,t){r.uniform2fv(e,new Float32Array(t))};this.Float3=function(e,t){r.uniform3fv(e,new Float32Array(t))};this.Float4=function(e,t){r.uniform4fv(e,new Float32Array(t))};var i=this;this.time=0;this.delta=0;this.lastTime=(new Date).getTime();this.timeWarp=1;this.basicShader=this.createShader("default-shader-fs","default-shader-vs",{PMat:this.Mat4x4,ModelMat:this.Mat4x4},[["Position",3,0,0]]);this.imgShader=this.createShader("texture-shader-fs","texture-shader-vs",{PMat:this.Mat4x4,ModelMat:this.Mat4x4,Color:function(e,t){i.Float4(e,!t?[1,1,1,1]:t)},s0:function(e,t){i.setTexture(e,t)}},[["Position",3,20,0],["TexCoord",2,20,12]]);this.identity=Matrix.I(4);this.perspectiveMatrix=this.identity;this.perspectiveCameraMatrix=this.identity;this.pass=[new TinyPass];this.imgIndices=this.createIndexBuffer([0,1,3,0,2,3]);var s=[];for(var o=0;o<4;++o){s[o*5]=o&1;s[o*5+1]=-((o&2)>>1);s[o*5+2]=-1;s[o*5+3]=o&1;s[o*5+4]=(o&2)>>1}this.imgVerts=this.createVertexBuffer(s);r.clearColor(0,0,0,1);r.enable(r.DEPTH_TEST);r.enable(r.BLEND);r.blendFunc(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA);r.depthFunc(r.LEQUAL);var u=function(s){i.canvaswidth=e.width=window.innerWidth;i.canvasheight=e.height=window.innerHeight;r.viewport(0,0,e.width,e.height);i.perspectiveMatrix=makePerspective(n,e.width/e.height,.1,t);i.needredraw=true;i.hfov=2*Math.atan(Math.tan(n*Math.PI/360)*e.width/e.height)};addEvent(window,"resize",u);window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)}}();u({})}function tinywgl_render(e){var t=this.gl;for(var n in e.shader.props){e.shader.props[n](e.shader.propLoc[n],e.params[n])}if(!e.indices){t.drawArrays(e.type,0,e.count)}else{t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,e.indices);t.drawElements(e.type,e.count,t.UNSIGNED_SHORT,0)}}function createShader(e,t,n,r){var i=this.gl;var s=this.getShader(e);var o=this.getShader(t);var u=i.createProgram();i.attachShader(u,o);i.attachShader(u,s);i.linkProgram(u);if(!i.getProgramParameter(u,i.LINK_STATUS)){alert("Unable to initialize the shader program.")}u.props=n;u.attributes=r;for(var a=0;a<u.attributes.length;a++){u.attributes[a][0]=i.getAttribLocation(u,u.attributes[a][0]);i.enableVertexAttribArray(u.attributes[a][0])}u.propLoc={};for(var f in u.props){u.propLoc[f]=i.getUniformLocation(u,f)}return u}function getShader(e){var t=this.gl;var n=document.getElementById(e);if(!n){return null}var r="";var i=n.firstChild;while(i){if(i.nodeType==3){r+=i.textContent}i=i.nextSibling}var s;if(n.type=="x-shader/x-fragment"){s=t.createShader(t.FRAGMENT_SHADER)}else if(n.type=="x-shader/x-vertex"){s=t.createShader(t.VERTEX_SHADER)}else{return null}t.shaderSource(s,r);t.compileShader(s);if(!t.getShaderParameter(s,t.COMPILE_STATUS)){alert(t.getShaderInfoLog(s));return null}return s}function defaultTexLoad(e,t){var n=this.gl;n.bindTexture(n.TEXTURE_2D,t);n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE);n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE);n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.LINEAR);n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR);n.texImage2D(n.TEXTURE_2D,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,e);n.bindTexture(n.TEXTURE_2D,null)}function pow2TexLoad(e,t){var n=this.gl;n.bindTexture(n.TEXTURE_2D,t);n.texImage2D(n.TEXTURE_2D,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,e);n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.LINEAR);n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR_MIPMAP_NEAREST);n.generateMipmap(n.TEXTURE_2D);n.bindTexture(n.TEXTURE_2D,null)}function loadTexture(e,t){var n=this.gl.createTexture();var r=new Image;var i=this;r.onload=!t?function(){i.defaultTexLoad(r,n)}:function(){t(r,n)};r.src=e;return n}function setTexture(e,t,n){var r=this.gl;if(!n)n=0;r.activeTexture(r["TEXTURE"+n]);r.bindTexture(r.TEXTURE_2D,t);r.uniform1i(e,n)}function createRenderTarget(e,t){var n=this.gl;var r=n.createFramebuffer();n.bindFramebuffer(n.FRAMEBUFFER,r);r.width=!e?this.canvaswidth:e;r.height=!t?this.canvasheight:t;var i=n.createTexture();n.bindTexture(n.TEXTURE_2D,i);n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE);n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE);n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.LINEAR);n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR);n.texImage2D(n.TEXTURE_2D,0,n.RGBA,r.width,r.height,0,n.RGBA,n.UNSIGNED_BYTE,null);var s=n.createRenderbuffer();n.bindRenderbuffer(n.RENDERBUFFER,s);n.renderbufferStorage(n.RENDERBUFFER,n.DEPTH_COMPONENT16,r.width,r.height);n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,i,0);n.framebufferRenderbuffer(n.FRAMEBUFFER,n.DEPTH_ATTACHMENT,n.RENDERBUFFER,s);n.bindTexture(n.TEXTURE_2D,null);n.bindRenderbuffer(n.RENDERBUFFER,null);n.bindFramebuffer(n.FRAMEBUFFER,null);return{rt:r,tex:i,renderbuffer:s}}function createVertexBuffer(e){var t=this.gl;var n=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,n);t.bufferData(t.ARRAY_BUFFER,new Float32Array(e),t.STATIC_DRAW);return n}function createIndexBuffer(e){var t=this.gl;var n=t.createBuffer();t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,n);t.bufferData(t.ELEMENT_ARRAY_BUFFER,new Uint16Array(e),t.STATIC_DRAW);return n}function applyShader(e,t){var n=this.gl;if(e!=tinywgl__lastshader)n.useProgram(tinywgl__lastshader=e);if(t!=tinywgl__lastarraybuffer)n.bindBuffer(n.ARRAY_BUFFER,tinywgl__lastarraybuffer=t);for(var r=0;r<e.attributes.length;r++){var i=e.attributes[r];n.vertexAttribPointer(i[0],i[1],n.FLOAT,false,i[2],i[3])}}function draw(){var e=this.gl;var t=this;window.requestAnimFrame(function(){t.draw()});var n=(new Date).getTime();this.delta=n-this.lastTime;this.delta*=this.timeWarp;this.time+=this.delta;this.lastTime=n;if(this.timeWarp===0&&!this.needredraw)return;e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT);this.needredraw=false;for(var r=0;r<this.pass.length;r++){var i=this.pass[r];i.onDraw();this.perspectiveCameraMatrix=this.perspectiveMatrix.x(i.cameraMatrix);e.bindFramebuffer(e.FRAMEBUFFER,i.rendertarget);i.customDraw();for(var s=0;s<i.renderables.length;s++){var o=i.renderables[s];if(!o.render(this)){tinywgl.applyShader(o.shader,o.verts);tinywgl.render(o)}}}}function TinyImage(e,t,n,r){if(typeof e==="string")e=[e];if(!n)n=t.imgShader;this.verts=t.imgVerts;this.count=6;this.indices=t.imgIndices;this.params={ModelMat:Matrix.I(4)};for(var i=0;i<e.length;++i){this.params["s"+i]=t.loadTexture(e[i],!r?0:function(e,n){t.pow2TexLoad(e,n)})}this.shader=n;this.type=t.gl.TRIANGLES;this.render=function(e){this.params["PMat"]=t.perspectiveCameraMatrix}}function FullScreenQuad(e,t){var n=[];for(var r=0;r<4;++r){n[r*5]=((r&1)<<1)-1;n[r*5+1]=-((r&2)-1);n[r*5+2]=0;n[r*5+3]=r&1;n[r*5+4]=(r&2)>>1}this.verts=t.createVertexBuffer(n);this.count=6;this.indices=t.imgIndices;this.params={PMat:Matrix.I(4),ModelMat:Matrix.I(4),s0:e};this.shader=t.imgShader;this.type=t.gl.TRIANGLES;this.render=function(){}}var addEvent=function(e,t,n){if(e==null||e==undefined)return;if(e.addEventListener){e.addEventListener(t,n,false)}else if(e.attachEvent){e.attachEvent("on"+t,n)}else{e["on"+t]=n}};var tinywgl__lastshader=null;var tinywgl__lastarraybuffer=null